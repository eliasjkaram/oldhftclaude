---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: trading-system
  labels:
    name: trading-system
    environment: production

---
# Storage Classes
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
  namespace: trading-system
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  iops: "10000"
  throughput: "250"
reclaimPolicy: Retain
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer

---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard-hdd
  namespace: trading-system
provisioner: kubernetes.io/aws-ebs
parameters:
  type: st1
reclaimPolicy: Retain
allowVolumeExpansion: true

---
# ConfigMaps
apiVersion: v1
kind: ConfigMap
metadata:
  name: trading-engine-config
  namespace: trading-system
data:
  config.yaml: |
    server:
      port: 8080
      workers: 4
    trading:
      max_order_size: 1000000
      risk_check_enabled: true
      circuit_breaker_threshold: 0.05
    kafka:
      brokers: kafka-0.kafka-headless:9092,kafka-1.kafka-headless:9092,kafka-2.kafka-headless:9092
      topics:
        orders: trading-orders
        executions: trading-executions
        market_data: market-data
    redis:
      cluster_endpoints:
        - redis-0.redis-headless:6379
        - redis-1.redis-headless:6379
        - redis-2.redis-headless:6379
    database:
      host: postgres-primary
      port: 5432
      name: trading_db
      pool_size: 20

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ml-model-config
  namespace: trading-system
data:
  model_config.json: |
    {
      "models": {
        "price_prediction": {
          "version": "v2.3.1",
          "path": "/models/price_prediction",
          "batch_size": 32,
          "gpu_memory_fraction": 0.8
        },
        "risk_assessment": {
          "version": "v1.5.0",
          "path": "/models/risk_assessment",
          "batch_size": 64
        }
      },
      "serving": {
        "grpc_port": 8500,
        "rest_port": 8501,
        "model_config_poll_wait_seconds": 60
      }
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: trading-system
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    scrape_configs:
      - job_name: 'trading-engine'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - trading-system
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: trading-engine
            action: keep
      - job_name: 'ml-models'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - trading-system
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: ml-model-serving
            action: keep

---
# Secrets
apiVersion: v1
kind: Secret
metadata:
  name: trading-secrets
  namespace: trading-system
type: Opaque
stringData:
  database-password: "SecureP@ssw0rd123!"
  api-key: "sk-trading-api-key-example"
  jwt-secret: "super-secret-jwt-key-for-production"
  kafka-password: "kafka-secure-password"
  redis-password: "redis-secure-password"

---
apiVersion: v1
kind: Secret
metadata:
  name: tls-certificates
  namespace: trading-system
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCi4uLgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0t
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCi4uLgotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0t

---
# Service Account and RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: trading-system-sa
  namespace: trading-system

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: trading-system-role
  namespace: trading-system
rules:
  - apiGroups: [""]
    resources: ["pods", "services", "configmaps", "secrets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: trading-system-rolebinding
  namespace: trading-system
subjects:
  - kind: ServiceAccount
    name: trading-system-sa
    namespace: trading-system
roleRef:
  kind: Role
  name: trading-system-role
  apiGroup: rbac.authorization.k8s.io

---
# Network Policies
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: trading-engine-network-policy
  namespace: trading-system
spec:
  podSelector:
    matchLabels:
      app: trading-engine
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: trading-system
        - podSelector:
            matchLabels:
              app: api-gateway
      ports:
        - protocol: TCP
          port: 8080
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: kafka
        - podSelector:
            matchLabels:
              app: redis
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP

---
# PostgreSQL StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: postgres-primary
  namespace: trading-system
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
  selector:
    app: postgres
    role: primary

---
apiVersion: v1
kind: Service
metadata:
  name: postgres-replica
  namespace: trading-system
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
  selector:
    app: postgres
    role: replica

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: trading-system
spec:
  serviceName: postgres
  replicas: 3
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      serviceAccountName: trading-system-sa
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              value: trading_db
            - name: POSTGRES_USER
              value: trading_user
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: database-password
            - name: POSTGRES_REPLICATION_MODE
              value: master
            - name: POSTGRES_REPLICATION_USER
              value: replicator
            - name: POSTGRES_REPLICATION_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: database-password
          resources:
            requests:
              memory: "2Gi"
              cpu: "1"
            limits:
              memory: "4Gi"
              cpu: "2"
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - trading_user
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - trading_user
            initialDelaySeconds: 5
            periodSeconds: 5
  volumeClaimTemplates:
    - metadata:
        name: postgres-storage
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 100Gi

---
# Kafka StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: kafka-headless
  namespace: trading-system
spec:
  clusterIP: None
  ports:
    - name: broker
      port: 9092
    - name: controller
      port: 9093
  selector:
    app: kafka

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: trading-system
spec:
  serviceName: kafka-headless
  replicas: 3
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      serviceAccountName: trading-system-sa
      containers:
        - name: kafka
          image: confluentinc/cp-kafka:7.5.0
          ports:
            - containerPort: 9092
              name: broker
            - containerPort: 9093
              name: controller
          env:
            - name: KAFKA_BROKER_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: KAFKA_ZOOKEEPER_CONNECT
              value: zookeeper-headless:2181
            - name: KAFKA_LISTENERS
              value: PLAINTEXT://:9092,CONTROLLER://:9093
            - name: KAFKA_ADVERTISED_LISTENERS
              value: PLAINTEXT://$(POD_NAME).kafka-headless:9092
            - name: KAFKA_CONTROLLER_LISTENER_NAMES
              value: CONTROLLER
            - name: KAFKA_LOG_DIRS
              value: /var/lib/kafka/data
            - name: KAFKA_AUTO_CREATE_TOPICS_ENABLE
              value: "false"
            - name: KAFKA_DEFAULT_REPLICATION_FACTOR
              value: "3"
            - name: KAFKA_MIN_INSYNC_REPLICAS
              value: "2"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          resources:
            requests:
              memory: "2Gi"
              cpu: "1"
            limits:
              memory: "4Gi"
              cpu: "2"
          volumeMounts:
            - name: kafka-storage
              mountPath: /var/lib/kafka/data
          livenessProbe:
            tcpSocket:
              port: 9092
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 9092
            initialDelaySeconds: 15
            periodSeconds: 5
  volumeClaimTemplates:
    - metadata:
        name: kafka-storage
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 200Gi

---
# Redis StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: redis-headless
  namespace: trading-system
spec:
  clusterIP: None
  ports:
    - port: 6379
      targetPort: 6379
  selector:
    app: redis

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: trading-system
spec:
  serviceName: redis-headless
  replicas: 3
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      serviceAccountName: trading-system-sa
      containers:
        - name: redis
          image: redis:7-alpine
          command:
            - redis-server
            - --cluster-enabled
            - "yes"
            - --cluster-config-file
            - nodes.conf
            - --cluster-node-timeout
            - "5000"
            - --appendonly
            - "yes"
            - --requirepass
            - $(REDIS_PASSWORD)
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: redis-password
          ports:
            - containerPort: 6379
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "1"
          volumeMounts:
            - name: redis-storage
              mountPath: /data
          livenessProbe:
            exec:
              command:
                - redis-cli
                - -a
                - $(REDIS_PASSWORD)
                - ping
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - redis-cli
                - -a
                - $(REDIS_PASSWORD)
                - ping
            initialDelaySeconds: 5
            periodSeconds: 5
  volumeClaimTemplates:
    - metadata:
        name: redis-storage
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 50Gi

---
# Trading Engine Deployment
apiVersion: v1
kind: Service
metadata:
  name: trading-engine
  namespace: trading-system
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      name: http
    - port: 9090
      targetPort: 9090
      name: metrics
  selector:
    app: trading-engine

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: trading-engine
  namespace: trading-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: trading-engine
  template:
    metadata:
      labels:
        app: trading-engine
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: trading-system-sa
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - trading-engine
              topologyKey: kubernetes.io/hostname
      containers:
        - name: trading-engine
          image: trading-system/trading-engine:v1.0.0
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 9090
              name: metrics
          env:
            - name: CONFIG_PATH
              value: /config/config.yaml
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: database-password
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: api-key
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: jwt-secret
          resources:
            requests:
              memory: "2Gi"
              cpu: "1"
            limits:
              memory: "4Gi"
              cpu: "2"
          volumeMounts:
            - name: config
              mountPath: /config
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
      volumes:
        - name: config
          configMap:
            name: trading-engine-config

---
# ML Model Serving Deployment
apiVersion: v1
kind: Service
metadata:
  name: ml-model-serving
  namespace: trading-system
spec:
  type: ClusterIP
  ports:
    - port: 8500
      targetPort: 8500
      name: grpc
    - port: 8501
      targetPort: 8501
      name: rest
  selector:
    app: ml-model-serving

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ml-model-serving
  namespace: trading-system
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ml-model-serving
  template:
    metadata:
      labels:
        app: ml-model-serving
    spec:
      serviceAccountName: trading-system-sa
      nodeSelector:
        node.kubernetes.io/gpu: "true"
      containers:
        - name: tensorflow-serving
          image: tensorflow/serving:2.14.0-gpu
          ports:
            - containerPort: 8500
              name: grpc
            - containerPort: 8501
              name: rest
          env:
            - name: MODEL_CONFIG_FILE
              value: /config/model_config.json
          resources:
            requests:
              memory: "4Gi"
              cpu: "2"
              nvidia.com/gpu: "1"
            limits:
              memory: "8Gi"
              cpu: "4"
              nvidia.com/gpu: "1"
          volumeMounts:
            - name: model-config
              mountPath: /config
            - name: model-storage
              mountPath: /models
          livenessProbe:
            httpGet:
              path: /v1/models/price_prediction
              port: 8501
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /v1/models/price_prediction
              port: 8501
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: model-config
          configMap:
            name: ml-model-config
        - name: model-storage
          persistentVolumeClaim:
            claimName: ml-models-pvc

---
# ML Models PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ml-models-pvc
  namespace: trading-system
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: standard-hdd
  resources:
    requests:
      storage: 500Gi

---
# Data Pipeline Deployment
apiVersion: v1
kind: Service
metadata:
  name: data-pipeline
  namespace: trading-system
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
  selector:
    app: data-pipeline

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-pipeline
  namespace: trading-system
spec:
  replicas: 2
  selector:
    matchLabels:
      app: data-pipeline
  template:
    metadata:
      labels:
        app: data-pipeline
    spec:
      serviceAccountName: trading-system-sa
      containers:
        - name: data-pipeline
          image: trading-system/data-pipeline:v1.0.0
          ports:
            - containerPort: 8080
          env:
            - name: KAFKA_BROKERS
              value: kafka-headless:9092
            - name: KAFKA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: kafka-password
          resources:
            requests:
              memory: "2Gi"
              cpu: "1"
            limits:
              memory: "4Gi"
              cpu: "2"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5

---
# Risk Management System Deployment
apiVersion: v1
kind: Service
metadata:
  name: risk-management
  namespace: trading-system
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
  selector:
    app: risk-management

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: risk-management
  namespace: trading-system
spec:
  replicas: 2
  selector:
    matchLabels:
      app: risk-management
  template:
    metadata:
      labels:
        app: risk-management
    spec:
      serviceAccountName: trading-system-sa
      containers:
        - name: risk-management
          image: trading-system/risk-management:v1.0.0
          ports:
            - containerPort: 8080
          env:
            - name: REDIS_CLUSTER
              value: redis-headless:6379
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: redis-password
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "1"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 20
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5

---
# API Gateway Deployment
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: trading-system
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 8080
      name: http
    - port: 443
      targetPort: 8443
      name: https
  selector:
    app: api-gateway

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: trading-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      serviceAccountName: trading-system-sa
      containers:
        - name: api-gateway
          image: trading-system/api-gateway:v1.0.0
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 8443
              name: https
          env:
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: jwt-secret
            - name: TLS_CERT
              valueFrom:
                secretKeyRef:
                  name: tls-certificates
                  key: tls.crt
            - name: TLS_KEY
              valueFrom:
                secretKeyRef:
                  name: tls-certificates
                  key: tls.key
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "1"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 20
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5

---
# Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: trading-system-ingress
  namespace: trading-system
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "100"
spec:
  tls:
    - hosts:
        - api.trading-system.com
      secretName: trading-system-tls
  rules:
    - host: api.trading-system.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 80

---
# Horizontal Pod Autoscaler for Trading Engine
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: trading-engine-hpa
  namespace: trading-system
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: trading-engine
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    - type: Pods
      pods:
        metric:
          name: trading_engine_requests_per_second
        target:
          type: AverageValue
          averageValue: "1000"
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 60

---
# Vertical Pod Autoscaler for ML Model Serving
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: ml-model-vpa
  namespace: trading-system
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ml-model-serving
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
      - containerName: tensorflow-serving
        minAllowed:
          cpu: 1
          memory: 2Gi
        maxAllowed:
          cpu: 8
          memory: 16Gi

---
# Pod Disruption Budget for Trading Engine
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: trading-engine-pdb
  namespace: trading-system
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: trading-engine

---
# Pod Disruption Budget for Kafka
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: kafka-pdb
  namespace: trading-system
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: kafka

---
# Prometheus StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: trading-system
spec:
  type: ClusterIP
  ports:
    - port: 9090
      targetPort: 9090
  selector:
    app: prometheus

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: prometheus
  namespace: trading-system
spec:
  serviceName: prometheus
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      serviceAccountName: trading-system-sa
      containers:
        - name: prometheus
          image: prom/prometheus:v2.47.0
          args:
            - --config.file=/etc/prometheus/prometheus.yml
            - --storage.tsdb.path=/prometheus
            - --storage.tsdb.retention.time=30d
            - --web.enable-lifecycle
          ports:
            - containerPort: 9090
          resources:
            requests:
              memory: "2Gi"
              cpu: "1"
            limits:
              memory: "4Gi"
              cpu: "2"
          volumeMounts:
            - name: config
              mountPath: /etc/prometheus
            - name: prometheus-storage
              mountPath: /prometheus
      volumes:
        - name: config
          configMap:
            name: prometheus-config
  volumeClaimTemplates:
    - metadata:
        name: prometheus-storage
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 100Gi

---
# Grafana Deployment
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: trading-system
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: 3000
  selector:
    app: grafana

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: trading-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      serviceAccountName: trading-system-sa
      containers:
        - name: grafana
          image: grafana/grafana:10.1.0
          ports:
            - containerPort: 3000
          env:
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: database-password
            - name: GF_INSTALL_PLUGINS
              value: "grafana-clock-panel,grafana-piechart-panel"
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          volumeMounts:
            - name: grafana-storage
              mountPath: /var/lib/grafana
      volumes:
        - name: grafana-storage
          persistentVolumeClaim:
            claimName: grafana-pvc

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-pvc
  namespace: trading-system
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: standard-hdd
  resources:
    requests:
      storage: 10Gi

---
# ServiceMonitor for Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: trading-engine-monitor
  namespace: trading-system
spec:
  selector:
    matchLabels:
      app: trading-engine
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics

---
# Pod Security Policy
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: trading-system-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  hostNetwork: false
  hostIPC: false
  hostPID: false
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  supplementalGroups:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
  readOnlyRootFilesystem: false

---
# Backup CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: trading-system
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: trading-system-sa
          containers:
            - name: postgres-backup
              image: postgres:15-alpine
              command:
                - /bin/sh
                - -c
                - |
                  DATE=$(date +%Y%m%d_%H%M%S)
                  pg_dump -h postgres-primary -U trading_user -d trading_db > /backup/trading_db_$DATE.sql
                  find /backup -name "*.sql" -mtime +7 -exec rm {} \;
              env:
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: trading-secrets
                      key: database-password
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
          restartPolicy: OnFailure
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: backup-pvc

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-pvc
  namespace: trading-system
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: standard-hdd
  resources:
    requests:
      storage: 100Gi

---
# Fluentd DaemonSet for Log Aggregation
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: trading-system
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      <parse>
        @type json
        time_format %Y-%m-%dT%H:%M:%S.%NZ
      </parse>
    </source>
    <match kubernetes.**>
      @type elasticsearch
      host elasticsearch
      port 9200
      logstash_format true
      logstash_prefix trading-system
      <buffer>
        @type file
        path /var/log/fluentd-buffers/kubernetes.system.buffer
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 2
        flush_interval 5s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 2M
        queue_limit_length 8
        overflow_action block
      </buffer>
    </match>

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: trading-system
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
    spec:
      serviceAccountName: trading-system-sa
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
      containers:
        - name: fluentd
          image: fluent/fluentd-kubernetes-daemonset:v1.16-debian-elasticsearch8-1
          resources:
            requests:
              memory: 200Mi
              cpu: 100m
            limits:
              memory: 400Mi
              cpu: 200m
          volumeMounts:
            - name: config
              mountPath: /fluentd/etc
            - name: varlog
              mountPath: /var/log
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: fluentd-config
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers

---
# Jaeger for Distributed Tracing
apiVersion: v1
kind: Service
metadata:
  name: jaeger
  namespace: trading-system
spec:
  type: ClusterIP
  ports:
    - port: 16686
      targetPort: 16686
      name: ui
    - port: 14268
      targetPort: 14268
      name: collector
  selector:
    app: jaeger

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
  namespace: trading-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      serviceAccountName: trading-system-sa
      containers:
        - name: jaeger
          image: jaegertracing/all-in-one:1.48
          ports:
            - containerPort: 16686
              name: ui
            - containerPort: 14268
              name: collector
          env:
            - name: COLLECTOR_ZIPKIN_HOST_PORT
              value: ":9411"
            - name: SPAN_STORAGE_TYPE
              value: elasticsearch
            - name: ES_SERVER_URLS
              value: http://elasticsearch:9200
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "1"

---
# Feature Flags ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: feature-flags
  namespace: trading-system
data:
  flags.yaml: |
    features:
      new_risk_algorithm:
        enabled: false
        rollout_percentage: 0
      enhanced_ml_predictions:
        enabled: true
        rollout_percentage: 100
      real_time_analytics:
        enabled: true
        rollout_percentage: 50
      advanced_order_types:
        enabled: false
        rollout_percentage: 0
      multi_currency_support:
        enabled: true
        rollout_percentage: 100

---
# Secret Encryption at Rest
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - secrets
    providers:
      - aescbc:
          keys:
            - name: key1
              secret: <base64-encoded-key>
      - identity: {}